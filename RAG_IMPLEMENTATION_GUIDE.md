# RAG (Retrieval-Augmented Generation) å®ç°æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†åœ¨AIæ’ä»¶ç³»ç»Ÿä¸­å®ç°RAGåŠŸèƒ½çš„å®Œæ•´æ–¹æ¡ˆã€‚RAGé€šè¿‡å°†çŸ¥è¯†åº“æ£€ç´¢ä¸AIç”Ÿæˆç›¸ç»“åˆï¼Œèƒ½å¤Ÿä¸ºç”¨æˆ·æä¾›åŸºäºç‰¹å®šçŸ¥è¯†åº“çš„å‡†ç¡®å›ç­”ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

- âœ… **çŸ¥è¯†åº“é€‰æ‹©**: ç”¨æˆ·å¯ä»¥åœ¨å¯¹è¯ç•Œé¢é€‰æ‹©å·²é…ç½®çš„çŸ¥è¯†åº“
- âœ… **æ™ºèƒ½æ£€ç´¢**: åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„è¯­ä¹‰æœç´¢
- âœ… **ä¸Šä¸‹æ–‡å¢å¼º**: è‡ªåŠ¨å°†æ£€ç´¢åˆ°çš„ç›¸å…³å†…å®¹æ·»åŠ åˆ°AIæç¤ºä¸­
- âœ… **é€æ˜ä½“éªŒ**: ç”¨æˆ·ç•Œé¢ä¿æŒç®€æ´ï¼ŒRAGè¿‡ç¨‹åœ¨åå°è¿›è¡Œ
- âœ… **çµæ´»é…ç½®**: å¯è°ƒæ•´æ£€ç´¢å‚æ•°ã€ç›¸ä¼¼åº¦é˜ˆå€¼ç­‰è®¾ç½®
- âœ… **å¤šè¯­è¨€æ”¯æŒ**: å®Œæ•´çš„ä¸­è‹±æ–‡æœ¬åœ°åŒ–

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UI Layer                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ExpandableTextInput  â”‚  RAGSettingsView  â”‚  PluginDetailViewâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      Business Logic                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     RAGService        â”‚   PluginViewModel  â”‚ KnowledgeBase   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       Data Layer                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ KnowledgeBaseService  â”‚  EmbeddingService  â”‚ SQLiteVectorDB  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ çŸ¥è¯†åº“æ£€ç´¢ â†’ ä¸Šä¸‹æ–‡æ„å»º â†’ æç¤ºå¢å¼º â†’ AIå¤„ç† â†’ å›å¤æ˜¾ç¤º
```

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. RAGæœåŠ¡ (`RAGService.swift`)

ä¸»è¦è´Ÿè´£RAGæµç¨‹çš„åè°ƒå’Œç®¡ç†ï¼š

```swift
@MainActor
class RAGService: ObservableObject {
    static let shared = RAGService()
    
    @Published var configuration = RAGConfiguration()
    
    // æ ¸å¿ƒåŠŸèƒ½ï¼šå¢å¼ºç”¨æˆ·æç¤º
    func enhancePrompt(_ originalPrompt: String, 
                      using knowledgeBase: KnowledgeBase) async throws -> RAGContext
    
    // æ„å»ºç³»ç»Ÿæç¤º
    func buildSystemPrompt(with context: RAGContext) -> String
}
```

**ä¸»è¦æ–¹æ³•**:
- `enhancePrompt()`: æ£€ç´¢ç›¸å…³å†…å®¹å¹¶å¢å¼ºç”¨æˆ·æç¤º
- `buildSystemPrompt()`: ä¸ºAIæ¨¡å‹æ„å»ºåŒ…å«çŸ¥è¯†åº“ä¸Šä¸‹æ–‡çš„ç³»ç»Ÿæç¤º
- `hasRelevantContent()`: æ£€æŸ¥çŸ¥è¯†åº“æ˜¯å¦åŒ…å«ç›¸å…³ä¿¡æ¯

### 2. RAGé…ç½® (`RAGConfiguration`)

å¯é…ç½®çš„å‚æ•°ï¼š

```swift
struct RAGConfiguration: Codable {
    var enabled: Bool = true              // æ˜¯å¦å¯ç”¨RAG
    var maxResults: Int = 5               // æœ€å¤§æ£€ç´¢ç»“æœæ•°
    var similarityThreshold: Float = 0.7  // ç›¸ä¼¼åº¦é˜ˆå€¼
    var maxContextLength: Int = 2000      // æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦
    var includeMetadata: Bool = false     // æ˜¯å¦åŒ…å«å…ƒæ•°æ®
    var contextTemplate: String          // ä¸Šä¸‹æ–‡æ¨¡æ¿
}
```

### 3. ç”¨æˆ·ç•Œé¢é›†æˆ

#### çŸ¥è¯†åº“é€‰æ‹©å™¨
```swift
// ExpandableTextInputä¸­çš„çŸ¥è¯†åº“é€‰æ‹©æŒ‰é’®
ToolbarButton(
    icon: selectedKnowledgeBase != nil ? "books.vertical.fill" : "books.vertical",
    tooltip: selectedKnowledgeBase?.name ?? "Select knowledge base"
) {
    showingKnowledgeBaseSelection.toggle()
}
```

#### æ’ä»¶æ‰§è¡Œå¢å¼º
```swift
// PluginViewModelä¸­çš„RAGå¢å¼ºæ‰§è¡Œ
private func executePluginWithRAG(prompt: String) {
    guard let knowledgeBase = selectedKnowledgeBase else {
        executePlugin(prompt: prompt)
        return
    }
    
    Task { @MainActor in
        do {
            let ragContext = try await ragService.enhancePrompt(prompt, using: knowledgeBase)
            executePlugin(prompt: ragContext.enhancedPrompt)
        } catch {
            executePlugin(prompt: prompt) // é™çº§å¤„ç†
        }
    }
}
```

## ğŸ’» ä½¿ç”¨æ–¹æ³•

### 1. åŸºç¡€ä½¿ç”¨

1. **é…ç½®çŸ¥è¯†åº“**: åœ¨è®¾ç½®ä¸­åˆ›å»ºå’Œé…ç½®çŸ¥è¯†åº“
2. **é€‰æ‹©çŸ¥è¯†åº“**: åœ¨è¾“å…¥æ¡†ä¸‹æ–¹ç‚¹å‡»çŸ¥è¯†åº“é€‰æ‹©æŒ‰é’®
3. **æ­£å¸¸å¯¹è¯**: è¾“å…¥é—®é¢˜ï¼Œç³»ç»Ÿè‡ªåŠ¨ä½¿ç”¨RAGå¢å¼ºå›å¤

### 2. é«˜çº§é…ç½®

è¿›å…¥ `è®¾ç½® â†’ RAGé…ç½®` è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š

- **æœ€å¤§æ£€ç´¢ç»“æœæ•°**: æ§åˆ¶ä»çŸ¥è¯†åº“æ£€ç´¢çš„å†…å®¹å—æ•°é‡
- **ç›¸ä¼¼åº¦é˜ˆå€¼**: è¿‡æ»¤ä½ç›¸å…³æ€§çš„å†…å®¹
- **æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦**: é™åˆ¶ä¼ é€’ç»™AIçš„ä¸Šä¸‹æ–‡æ–‡æœ¬é•¿åº¦
- **ä¸Šä¸‹æ–‡æ¨¡æ¿**: è‡ªå®šä¹‰ä¸Šä¸‹æ–‡æ ¼å¼

### 3. å¼€å‘è€…é›†æˆ

```swift
// åœ¨æ’ä»¶ä¸­ä½¿ç”¨RAG
let ragService = RAGService.shared
let context = try await ragService.enhancePrompt(userQuery, using: knowledgeBase)

// è·å–å¢å¼ºåçš„æç¤º
let enhancedPrompt = context.enhancedPrompt

// è·å–ç³»ç»Ÿæç¤º
let systemPrompt = ragService.buildSystemPrompt(with: context)
```

## âš™ï¸ é…ç½®å‚æ•°è¯¦è§£

### RAGConfiguration å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `enabled` | Bool | true | å…¨å±€RAGå¼€å…³ |
| `maxResults` | Int | 5 | æ£€ç´¢ç»“æœæ•°é‡é™åˆ¶ |
| `similarityThreshold` | Float | 0.7 | ç›¸ä¼¼åº¦é˜ˆå€¼(0.0-1.0) |
| `maxContextLength` | Int | 2000 | ä¸Šä¸‹æ–‡æ–‡æœ¬é•¿åº¦é™åˆ¶ |
| `includeMetadata` | Bool | false | æ˜¯å¦æ˜¾ç¤ºç›¸ä¼¼åº¦åˆ†æ•° |
| `contextTemplate` | String | é¢„å®šä¹‰æ¨¡æ¿ | ä¸Šä¸‹æ–‡æ ¼å¼æ¨¡æ¿ |

### æ¨èé…ç½®

**é€šç”¨åœºæ™¯**:
```swift
maxResults = 5
similarityThreshold = 0.7
maxContextLength = 2000
```

**é«˜ç²¾åº¦åœºæ™¯**:
```swift
maxResults = 3
similarityThreshold = 0.8
maxContextLength = 1500
```

**å¹¿æ³›è¦†ç›–åœºæ™¯**:
```swift
maxResults = 10
similarityThreshold = 0.6
maxContextLength = 3000
```

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

é¡¹ç›®åŒ…å«å®Œæ•´çš„æµ‹è¯•å¥—ä»¶ `test_rag_functionality.swift`:

```bash
# è¿è¡ŒRAGåŠŸèƒ½æµ‹è¯•
swift test_rag_functionality.swift
```

æµ‹è¯•è¦†ç›–ï¼š
- âœ… é…ç½®ç®¡ç†
- âœ… çŸ¥è¯†åº“é€‰æ‹©
- âœ… ä¸Šä¸‹æ–‡æ„å»º
- âœ… æç¤ºå¢å¼º
- âœ… æ€§èƒ½æµ‹è¯•
- âœ… é”™è¯¯å¤„ç†

## ğŸ” è°ƒè¯•å’Œç›‘æ§

### æ—¥å¿—è¾“å‡º

RAGæœåŠ¡ä¼šè¾“å‡ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š

```
RAGService: Enhanced prompt with 3 relevant chunks
PluginViewModel: RAG enhanced prompt with 3 results
```

### æ€§èƒ½ç›‘æ§

- ä¸Šä¸‹æ–‡æ„å»ºæ—¶é—´: < 1ç§’
- æç¤ºå¢å¼ºå¹³å‡æ—¶é—´: < 0.001ç§’
- å¤§æ•°æ®é›†å¤„ç†: < 5ç§’

### è°ƒè¯•æŠ€å·§

1. **æ£€æŸ¥çŸ¥è¯†åº“çŠ¶æ€**: ç¡®ä¿çŸ¥è¯†åº“ä¸º `ready` çŠ¶æ€
2. **è°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼**: å¦‚æœæ²¡æœ‰æ£€ç´¢åˆ°ç»“æœï¼Œé™ä½é˜ˆå€¼
3. **æŸ¥çœ‹æ—¥å¿—**: è§‚å¯Ÿæ£€ç´¢åˆ°çš„å—æ•°é‡å’Œç›¸ä¼¼åº¦åˆ†æ•°
4. **æµ‹è¯•æŸ¥è¯¢**: ä½¿ç”¨ç®€å•æ˜ç¡®çš„é—®é¢˜æµ‹è¯•

## âš ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. æ²¡æœ‰æ£€ç´¢åˆ°ç›¸å…³å†…å®¹**
- æ£€æŸ¥çŸ¥è¯†åº“æ˜¯å¦åŒ…å«ç›¸å…³å†…å®¹
- é™ä½ `similarityThreshold` å‚æ•°
- æ£€æŸ¥çŸ¥è¯†åº“ç´¢å¼•æ˜¯å¦å®Œæ•´

**2. ä¸Šä¸‹æ–‡è¿‡é•¿**
- å‡å°‘ `maxResults` å‚æ•°
- é™ä½ `maxContextLength` å‚æ•°
- ä¼˜åŒ–ä¸Šä¸‹æ–‡æ¨¡æ¿

**3. å“åº”è´¨é‡ä¸ä½³**
- æé«˜ `similarityThreshold` å‚æ•°
- æ£€æŸ¥çŸ¥è¯†åº“å†…å®¹è´¨é‡
- è°ƒæ•´ä¸Šä¸‹æ–‡æ¨¡æ¿

**4. æ€§èƒ½é—®é¢˜**
- å‡å°‘ `maxResults` å‚æ•°
- ä¼˜åŒ–çŸ¥è¯†åº“ç´¢å¼•
- æ£€æŸ¥å‘é‡æ•°æ®åº“æ€§èƒ½

### é”™è¯¯ä»£ç 

| é”™è¯¯ | æè¿° | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| `knowledgeBaseNotReady` | çŸ¥è¯†åº“æœªå°±ç»ª | å®ŒæˆçŸ¥è¯†åº“é…ç½®å’Œç´¢å¼• |
| `searchFailed` | æœç´¢å¤±è´¥ | æ£€æŸ¥å‘é‡æ•°æ®åº“è¿æ¥ |
| `noRelevantContent` | æ— ç›¸å…³å†…å®¹ | è°ƒæ•´æœç´¢å‚æ•°æˆ–æ›´æ–°çŸ¥è¯†åº“ |
| `configurationError` | é…ç½®é”™è¯¯ | æ£€æŸ¥RAGé…ç½®å‚æ•° |

## ğŸ“ æœ€ä½³å®è·µ

### çŸ¥è¯†åº“ç®¡ç†
1. ä¿æŒçŸ¥è¯†åº“å†…å®¹çš„æ›´æ–°å’Œè´¨é‡
2. å®šæœŸæ¸…ç†å’Œä¼˜åŒ–ç´¢å¼•
3. åˆç†åˆ†ç±»ä¸åŒç±»å‹çš„çŸ¥è¯†åº“

### RAGé…ç½®
1. æ ¹æ®åº”ç”¨åœºæ™¯è°ƒæ•´å‚æ•°
2. å®šæœŸè¯„ä¼°å’Œä¼˜åŒ–é…ç½®
3. ç›‘æ§æ€§èƒ½å’Œè´¨é‡æŒ‡æ ‡

### ç”¨æˆ·ä½“éªŒ
1. æä¾›æ¸…æ™°çš„çŸ¥è¯†åº“é€‰æ‹©ç•Œé¢
2. åœ¨é€‚å½“æ—¶æœºæç¤ºç”¨æˆ·RAGçš„ä½¿ç”¨
3. ä¿æŒç•Œé¢ç®€æ´ï¼Œé¿å…è¿‡åº¦å¤æ‚åŒ–

## ğŸ”— ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶
- `Services/RAGService.swift` - RAGæ ¸å¿ƒæœåŠ¡
- `Views/Components/ExpandableTextInput.swift` - è¾“å…¥ç»„ä»¶
- `ViewModels/PluginViewModel.swift` - æ’ä»¶è§†å›¾æ¨¡å‹
- `Views/Settings/RAGSettingsView.swift` - RAGè®¾ç½®ç•Œé¢

### é…ç½®æ–‡ä»¶
- `Models/SettingsSection.swift` - è®¾ç½®åˆ†ç±»
- `Resources/*/Localizable.strings` - æœ¬åœ°åŒ–å­—ç¬¦ä¸²

### æµ‹è¯•æ–‡ä»¶
- `test_rag_functionality.swift` - åŠŸèƒ½æµ‹è¯•è„šæœ¬

## ğŸš€ æœªæ¥æ‰©å±•

### è®¡åˆ’åŠŸèƒ½
- [ ] å¤šçŸ¥è¯†åº“åŒæ—¶æ£€ç´¢
- [ ] æ£€ç´¢ç»“æœç¼“å­˜æœºåˆ¶
- [ ] è‡ªé€‚åº”ç›¸ä¼¼åº¦é˜ˆå€¼
- [ ] RAGä½¿ç”¨ç»Ÿè®¡å’Œåˆ†æ
- [ ] æ›´å¤šä¸Šä¸‹æ–‡æ¨¡æ¿é€‰é¡¹

### æ€§èƒ½ä¼˜åŒ–
- [ ] å¼‚æ­¥æ£€ç´¢ä¼˜åŒ–
- [ ] å‘é‡ç´¢å¼•æ€§èƒ½æå‡
- [ ] å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- [ ] æ‰¹é‡å¤„ç†æ”¯æŒ

## ğŸ“ æ”¯æŒå’Œåé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
1. æŸ¥é˜…æœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½
3. æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯
4. è”ç³»å¼€å‘å›¢é˜Ÿè·å–æ”¯æŒ

---

*æœ¬æ–‡æ¡£éšRAGåŠŸèƒ½çš„æ›´æ–°è€ŒæŒç»­ç»´æŠ¤*